import * as datetime from "./datetime.js";
import { RedmineAPIService } from "./services.js";
const redmineService = new RedmineAPIService(T2R_REDMINE_API_KEY);
export const Widget = {};
function buildDropdownFromDictionary(data) {
    const $el = $('<select />');
    const placeholder = data.placeholder || null;
    const attributes = data.attributes || null;
    if (placeholder) {
        $el.append(`<option value="">${placeholder}</option>`);
    }
    if (attributes) {
        $el.attr(data.attributes);
    }
    for (const value in data.options) {
        const label = data.options[value];
        $el.append(`<option value="${value}">${label}</option>`);
    }
    return $el;
}
function buildDropdownFromRecords(data) {
    data.options = {};
    for (const record of data.records) {
        data.options[record.id] = record.name;
    }
    delete data['records'];
    return buildDropdownFromDictionary(data);
}
Widget.initialize = function (el = document.body) {
    $(el).find('[data-t2r-widget]')
        .each(function () {
        const widgetList = this.getAttribute('data-t2r-widget');
        if (!widgetList)
            return;
        for (const widget of widgetList.split(' ')) {
            const flag = 'Widget' + widget + 'Ready';
            if (this.dataset[flag] == 'true') {
                continue;
            }
            const method = 'init' + widget;
            if ('undefined' !== typeof Widget[method]) {
                Widget[method](this);
                this.dataset[flag] = 'true';
                this.classList.add(`t2r-widget-${widget}`);
            }
            else {
                throw `To initialize "${widget}", please define "widgets.${method}"`;
            }
        }
    });
};
Widget.initTooltip = function (el) {
    $(el).tooltip();
};
Widget.initTogglRow = function (el) {
    const $el = $(el);
    $el.find('.cb-import')
        .on('change', function () {
        const $checkbox = $(this);
        const $tr = $checkbox.closest('tr');
        if ($checkbox.is(':checked')) {
            $tr.find(':input')
                .not('.cb-import')
                .removeAttr('disabled')
                .attr('required', 'required');
        }
        else {
            $tr.find(':input')
                .not('.cb-import')
                .removeAttr('required')
                .attr('disabled', 'disabled');
        }
    })
        .trigger('change');
    $el.find(':input').tooltip();
};
Widget.initDurationInput = function (el) {
    var $el = $(el);
    $el
        .on('input', function () {
        const val = $el.val();
        try {
            new datetime.Duration(val);
            el.setCustomValidity('');
        }
        catch (e) {
            el.setCustomValidity(e);
        }
    })
        .on('keyup', function (e) {
        const $input = $(this);
        const dur = new datetime.Duration();
        try {
            dur.setHHMM($input.val());
        }
        catch (e) {
            return;
        }
        const mm = dur.minutes % 60;
        const step = e.shiftKey ? 15 : 5;
        let delta = 0;
        if (e.key === 'ArrowUp') {
            delta = step - (mm % step);
            dur.add(new datetime.Duration(delta * 60));
        }
        else if (e.key === 'ArrowDown') {
            delta = (mm % step) || step;
            dur.sub(new datetime.Duration(delta * 60));
        }
        else {
            return;
        }
        $(this).val(dur.asHHMM()).trigger('input').trigger('select');
    })
        .on('change', function () {
        const $input = $(this);
        const value = $input.val();
        const dur = new datetime.Duration();
        try {
            dur.setHHMM(value);
        }
        catch (e) {
            console.debug(`Could not understand time: ${value}`);
        }
        $input.val(dur.asHHMM());
    });
};
Widget.initRedmineActivityDropdown = function (el) {
    const $el = $(el);
    redmineService.getTimeEntryActivities((activities) => {
        const $select = buildDropdownFromRecords({
            placeholder: $el.data('placeholder'),
            records: activities
        });
        $el.append($select.find('option'));
        const value = $el.data('selected');
        if ('undefined' !== typeof value) {
            $el.val(value).data('selected', null);
        }
    });
};
Widget.initTogglWorkspaceDropdown = function (el) {
    const $el = $(el);
    redmineService.getTogglWorkspaces((workspaces) => {
        const $select = buildDropdownFromRecords({
            placeholder: $el.data('placeholder'),
            records: workspaces
        });
        $el.append($select.find('option'));
        const value = $el.data('selected');
        if ('undefined' !== typeof value) {
            $el.val(value).data('selected', null);
        }
    });
};
Widget.initDurationRoundingDirection = function (el) {
    const $el = $(el);
    const options = {};
    options[datetime.RoundingMethod.Regular] = 'Round off';
    options[datetime.RoundingMethod.Up] = 'Round up';
    options[datetime.RoundingMethod.Down] = 'Round down';
    const $select = buildDropdownFromDictionary({
        placeholder: 'Don\'t round',
        options: options
    });
    $el.append($select.find('option'));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2Fzc2V0cy5zcmMvamF2YXNjcmlwdHMvdDJyL3dpZGdldHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLFFBQVEsTUFBTSxlQUFlLENBQUE7QUFDekMsT0FBTyxFQUFDLGlCQUFpQixFQUFDLE1BQU0sZUFBZSxDQUFDO0FBS2hELE1BQU0sY0FBYyxHQUFHLElBQUksaUJBQWlCLENBQUMsbUJBQW1CLENBQUMsQ0FBQTtBQUtqRSxNQUFNLENBQUMsTUFBTSxNQUFNLEdBQVEsRUFBRSxDQUFBO0FBRTdCLFNBQVMsMkJBQTJCLENBQUMsSUFBUztJQUM1QyxNQUFNLEdBQUcsR0FBRyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUE7SUFDM0IsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUE7SUFDNUMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUE7SUFFMUMsSUFBSSxXQUFXLEVBQUU7UUFDZixHQUFHLENBQUMsTUFBTSxDQUFDLG9CQUFvQixXQUFXLFdBQVcsQ0FBQyxDQUFBO0tBQ3ZEO0lBRUQsSUFBSSxVQUFVLEVBQUU7UUFDZCxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQTtLQUMxQjtJQUVELEtBQUssTUFBTSxLQUFLLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtRQUNoQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ2pDLEdBQUcsQ0FBQyxNQUFNLENBQUMsa0JBQWtCLEtBQUssS0FBSyxLQUFLLFdBQVcsQ0FBQyxDQUFBO0tBQ3pEO0lBRUQsT0FBTyxHQUFHLENBQUE7QUFDWixDQUFDO0FBRUQsU0FBUyx3QkFBd0IsQ0FBQyxJQUFTO0lBQ3pDLElBQUksQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFB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